name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint Code
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python linting tools
      run: |
        pip install flake8 black
    
    - name: Lint Python with flake8
      run: |
        flake8 src/ tests/ code/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ code/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
    
    - name: Check Python formatting with black
      run: |
        black --check --diff src/ tests/ code/ || true
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install ESLint
      run: |
        npm install -g eslint
    
    - name: Lint JavaScript
      run: |
        eslint ui/*.js --fix-dry-run || true

  test:
    runs-on: ubuntu-latest
    name: Run Tests
    needs: lint
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r src/requirements.txt
        pip install pytest pytest-cov
    
    - name: Run safety tests
      run: |
        pytest tests/test_safety.py -v
    
    - name: Run budget tests
      run: |
        pytest tests/test_budget.py -v
    
    - name: Run scraper tests
      run: |
        pytest tests/test_scraper.py -v
    
    - name: Generate coverage report
      run: |
        pytest --cov=src --cov-report=xml --cov-report=html
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        fail_ci_if_error: false

  validate-bom:
    runs-on: ubuntu-latest
    name: Validate BOM Budget
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Validate BOM price
      run: |
        python tests/test_budget.py
    
    - name: Check for unsafe suppliers
      run: |
        # Ensure no restricted/paywalled suppliers in BOM
        if grep -i "elsevier\|springer\|wiley" bom/BOM.csv; then
          echo "ERROR: Paywalled suppliers found in BOM"
          exit 1
        fi
        echo "✓ BOM suppliers validated"

  test-ui:
    runs-on: ubuntu-latest
    name: Test UI Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Verify UI files exist
      run: |
        test -f ui/index.html
        test -f ui/style.css
        test -f ui/app.js
        test -f ui/thought-map.html
        test -f ui/breadboard.html
        echo "✓ All UI files present"
    
    - name: Validate HTML
      run: |
        npm install -g html-validate
        html-validate ui/*.html || true
    
    - name: Test local server
      run: |
        python -m http.server 8080 --directory ui &
        sleep 2
        curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200" && echo "✓ Server responds" || exit 1
        pkill -f "http.server"

  build:
    runs-on: ubuntu-latest
    name: Build Release Package
    needs: [lint, test, validate-bom, test-ui]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create release archive
      run: |
        zip -r QuantumFluxLab.zip . \
          -x "*.git*" \
          -x "*.pyc" \
          -x "__pycache__/*" \
          -x "*.zip" \
          -x ".pytest_cache/*" \
          -x "*.egg-info/*"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: QuantumFluxLab
        path: QuantumFluxLab.zip
        retention-days: 90
    
    - name: Calculate checksum
      run: |
        sha256sum QuantumFluxLab.zip > checksum.txt
        cat checksum.txt

  safety-check:
    runs-on: ubuntu-latest
    name: Hardware Safety Verification
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify fail-safe circuit code
      run: |
        # Check that emergency stop is in the code
        if ! grep -q "EMERGENCY_STOP\|emergency.*stop\|E-Stop" code/qfl_controller.ino; then
          echo "ERROR: Emergency stop not found in controller code"
          exit 1
        fi
        
        # Check for watchdog timer
        if ! grep -q "watchdog\|WDT\|Watchdog" code/qfl_controller.ino; then
          echo "ERROR: Watchdog timer not found in controller code"
          exit 1
        fi
        
        # Check for safety relay
        if ! grep -q "relay\|RELAY" code/qfl_controller.ino; then
          echo "ERROR: Safety relay not found in controller code"
          exit 1
        fi
        
        # Check for temperature monitoring
        if ! grep -q "temperature\|temp\|TEMP" code/qfl_controller.ino; then
          echo "ERROR: Temperature monitoring not found in controller code"
          exit 1
        fi
        
        echo "✓ All safety features verified in controller code"
    
    - name: Check safety thresholds
      run: |
        # Verify safety limits are reasonable
        if grep -E "CRITICAL.*[0-9]+000" code/qfl_controller.ino; then
          echo "WARNING: Very high voltage threshold detected - manual review required"
        fi
        
        # Check ozone limits
        if ! grep -q "0.08\|0.1" code/qfl_controller.ino; then
          echo "ERROR: Ozone safety threshold not found"
          exit 1
        fi
        
        echo "✓ Safety thresholds verified"

  open-access-check:
    runs-on: ubuntu-latest
    name: Open Access Compliance
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify whitelist exists
      run: |
        test -f src/whitelist.json
        test -f src/blacklist.log
        echo "✓ Open access lists present"
    
    - name: Check for paywalled citations
      run: |
        # Check docs for any blacklisted domains
        if grep -r -i "elsevier.com\|springer.com\|wiley.com\|sciencedirect.com\|nature.com" docs/ logs/; then
          echo "WARNING: Potentially paywalled source found - verify open access status"
        fi
        echo "✓ Citation check complete"
